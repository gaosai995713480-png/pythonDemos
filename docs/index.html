<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, viewport-fit=cover"
    />
    <title>心动告白</title>
    <style>
      :root {
        --bg-1: #ff9a9e;
        --bg-2: #fad0c4;
        --bg-3: #ffd1ff;
        --heart: #ff4d6d;
        --heart-glow: rgba(255, 77, 109, 0.55);
        --text: #5b2a3f;
      }

      * {
        box-sizing: border-box;
      }

      body {
        margin: 0;
        min-height: 100vh;
        display: flex;
        align-items: center;
        justify-content: center;
        background: radial-gradient(circle at top, var(--bg-3), transparent 55%),
          linear-gradient(135deg, var(--bg-1), var(--bg-2));
        color: var(--text);
        font-family: "KaiTi", "STKaiti", "Songti SC", "Noto Serif SC", serif;
        overflow: hidden;
      }

      .stage {
        position: relative;
        text-align: center;
        padding: 32px;
        z-index: 2;
      }

      h1 {
        margin: 0 0 12px;
        font-size: clamp(28px, 5vw, 42px);
        letter-spacing: 4px;
      }

      p {
        margin: 0;
        font-size: clamp(16px, 3vw, 20px);
        opacity: 0.85;
      }

      .heart {
        width: clamp(140px, 26vw, 200px);
        height: clamp(140px, 26vw, 200px);
        margin: 40px auto 46px;
        position: relative;
        transform: rotate(-45deg);
        background: var(--heart);
        animation: beat 1.2s ease-in-out infinite;
        box-shadow: 0 0 40px var(--heart-glow);
        z-index: 1;
      }

      .heart::before,
      .heart::after {
        content: "";
        width: 100%;
        height: 100%;
        position: absolute;
        background: var(--heart);
        border-radius: 50%;
      }

      .heart::before {
        top: -50%;
        left: 0;
      }

      .heart::after {
        left: 50%;
        top: 0;
      }

      .glow-ring {
        position: absolute;
        inset: -18%;
        border-radius: 50%;
        border: 2px solid rgba(255, 255, 255, 0.4);
        animation: ripple 2.4s ease-out infinite;
      }

      .floating-layer {
        position: absolute;
        inset: 0;
        overflow: hidden;
        pointer-events: none;
        z-index: 1;
      }

      .floating-heart {
        position: absolute;
        left: var(--x);
        bottom: -15vh;
        width: var(--size);
        height: var(--size);
        background: rgba(255, 77, 109, 0.75);
        transform: rotate(-45deg);
        filter: drop-shadow(0 0 10px rgba(255, 77, 109, 0.45));
        animation: float var(--float-duration) ease-in forwards;
      }

      .floating-heart::before,
      .floating-heart::after {
        content: "";
        position: absolute;
        width: 100%;
        height: 100%;
        background: inherit;
        border-radius: 50%;
      }

      .floating-heart::before {
        top: -50%;
        left: 0;
      }

      .floating-heart::after {
        top: 0;
        left: 50%;
      }

      @keyframes beat {
        0%,
        100% {
          transform: rotate(-45deg) scale(1);
        }
        50% {
          transform: rotate(-45deg) scale(1.08);
        }
      }

      @keyframes ripple {
        0% {
          opacity: 0.7;
          transform: scale(0.8);
        }
        70% {
          opacity: 0;
          transform: scale(1.35);
        }
        100% {
          opacity: 0;
          transform: scale(1.35);
        }
      }

      @keyframes float {
        0% {
          transform: translateY(0) rotate(-45deg) scale(0.7);
          opacity: 0;
        }
        12% {
          opacity: 1;
        }
        100% {
          transform: translateY(-120vh) rotate(-45deg) scale(1.4);
          opacity: 0;
        }
      }

      .signature {
        margin-top: 10px;
        font-size: clamp(14px, 2.4vw, 16px);
        letter-spacing: 2px;
      }

      .lyrics {
        margin: 8px 0 120px;
        min-height: 24px;
        font-size: clamp(15px, 3vw, 20px);
        letter-spacing: 2px;
        color: #7a2f47;
        text-shadow: 0 4px 10px rgba(255, 255, 255, 0.6);
        position: relative;
        z-index: 3;
      }


      .slideshow {
        position: fixed;
        right: 24px;
        bottom: 96px;
        width: clamp(180px, 24vw, 260px);
        aspect-ratio: 3 / 4;
        padding: 10px;
        border-radius: 18px;
        background: rgba(255, 255, 255, 0.45);
        box-shadow: 0 18px 40px rgba(91, 42, 63, 0.25);
        overflow: hidden;
        display: flex;
        align-items: center;
        justify-content: center;
        backdrop-filter: blur(10px);
        z-index: 3;
      }

      .slideshow img {
        width: 100%;
        height: 100%;
        object-fit: cover;
        border-radius: 12px;
        transition: opacity 0.6s ease;
      }

      .slideshow figcaption {
        position: absolute;
        left: 14px;
        bottom: 12px;
        padding: 4px 10px;
        border-radius: 999px;
        font-size: 12px;
        color: #fff;
        background: rgba(255, 77, 109, 0.75);
        letter-spacing: 1px;
      }

      .slideshow img.is-fading {
        opacity: 0;
      }

      .play-button {
        right: 24px;
        bottom: 24px;
        width: 56px;
        height: 56px;
        position: fixed;
        border-radius: 50%;
        border: none;
        background: #ff4d6d;
        color: #fff;
        font-size: 22px;
        cursor: pointer;
        box-shadow: 0 12px 24px rgba(255, 77, 109, 0.4);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 3;
        overflow: hidden;
        transition: transform 0.2s ease, box-shadow 0.2s ease;
      }

      .play-button:hover {
        transform: translateY(-2px);
        box-shadow: 0 16px 30px rgba(255, 77, 109, 0.45);
      }

      .play-button::before {
        content: "";
        position: absolute;
        inset: 10px;
        border-radius: 50%;
        background: radial-gradient(
            circle,
            rgba(255, 255, 255, 0.85) 0 6%,
            rgba(255, 255, 255, 0.25) 7% 12%,
            rgba(0, 0, 0, 0.15) 13% 35%,
            rgba(0, 0, 0, 0.32) 36% 60%,
            rgba(0, 0, 0, 0.55) 61% 100%
          );
        box-shadow: inset 0 0 8px rgba(0, 0, 0, 0.35);
      }

      .play-button span {
        position: relative;
        z-index: 1;
      }

      .play-button.is-playing::before {
        animation: spin 2.6s linear infinite;
      }

      @keyframes spin {
        to {
          transform: rotate(360deg);
        }
      }

      .danmu-layer {
        position: fixed;
        inset: 0;
        pointer-events: none;
        overflow: hidden;
        z-index: 3;
      }

      .danmu-item {
        position: absolute;
        right: -20%;
        top: 0;
        padding: 6px 12px;
        border-radius: 999px;
        background: rgba(255, 255, 255, 0.75);
        color: #5b2a3f;
        font-size: 14px;
        letter-spacing: 1px;
        white-space: nowrap;
        box-shadow: 0 10px 22px rgba(91, 42, 63, 0.2);
        animation: danmu-move linear forwards;
        animation-duration: var(--duration, 12s);
        animation-delay: var(--delay, 0s);
      }

      @keyframes danmu-move {
        from {
          transform: translateX(0);
          opacity: 0;
        }
        6% {
          opacity: 1;
        }
        to {
          transform: translateX(-140vw);
          opacity: 0;
        }
      }

      .danmu-bar {
        position: fixed;
        left: 24px;
        right: 96px;
        bottom: 24px;
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 10px 12px;
        border-radius: 16px;
        background: rgba(255, 255, 255, 0.68);
        backdrop-filter: blur(10px);
        box-shadow: 0 16px 30px rgba(91, 42, 63, 0.2);
        z-index: 4;
      }

      .danmu-bar input {
        flex: 1;
        border: none;
        background: transparent;
        font-size: 14px;
        color: #5b2a3f;
        outline: none;
      }

      .danmu-bar input::placeholder {
        color: rgba(91, 42, 63, 0.6);
      }

      .danmu-bar button {
        border: none;
        padding: 6px 14px;
        border-radius: 999px;
        background: #ff4d6d;
        color: #fff;
        cursor: pointer;
      }

      .burst-heart {
        position: fixed;
        left: var(--x);
        top: var(--y);
        width: 14px;
        height: 14px;
        background: #ff4d6d;
        transform: translate(-50%, -50%) rotate(-45deg) scale(0.8);
        opacity: 0.95;
        filter: drop-shadow(0 4px 8px rgba(255, 77, 109, 0.45));
        animation: burst 1.4s ease-out forwards;
        pointer-events: none;
        z-index: 4;
      }

      .burst-heart::before,
      .burst-heart::after {
        content: "";
        position: absolute;
        width: 100%;
        height: 100%;
        background: inherit;
        border-radius: 50%;
      }

      .burst-heart::before {
        top: -50%;
        left: 0;
      }

      .burst-heart::after {
        top: 0;
        left: 50%;
      }

      @keyframes burst {
        to {
          transform: translate(
              calc(-50% + var(--dx)),
              calc(-50% + var(--dy))
            )
            rotate(-45deg)
            scale(1.2);
          opacity: 0;
        }
      }

      .note-backdrop {
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.35);
        opacity: 0;
        pointer-events: none;
        transition: opacity 0.2s ease;
        z-index: 4;
      }

      .note-backdrop.is-visible {
        opacity: 1;
        pointer-events: auto;
      }

      .note-card {
        position: fixed;
        left: 50%;
        top: 50%;
        transform: translate(-50%, -50%) scale(0.95);
        width: min(320px, 82vw);
        padding: 22px 20px;
        border-radius: 18px;
        background: rgba(255, 255, 255, 0.95);
        box-shadow: 0 20px 40px rgba(91, 42, 63, 0.35);
        opacity: 0;
        pointer-events: none;
        transition: opacity 0.2s ease, transform 0.2s ease;
        z-index: 5;
        text-align: center;
      }

      .note-card.is-visible {
        opacity: 1;
        transform: translate(-50%, -50%) scale(1);
        pointer-events: auto;
      }

      .note-card h2 {
        margin: 0 0 10px;
        font-size: 20px;
      }

      .note-card p {
        margin: 0 0 16px;
        font-size: 15px;
        line-height: 1.6;
      }

      .note-card button {
        border: none;
        padding: 8px 18px;
        border-radius: 999px;
        background: #ff4d6d;
        color: #fff;
        cursor: pointer;
      }

      @media (max-width: 720px) {
        body {
          align-items: flex-start;
          padding-top: 24px;
        }

        .stage {
          padding: 24px 22px 140px;
        }

        .lyrics {
          margin-bottom: 20px;
          line-height: 1.7;
        }

        .heart {
          width: clamp(110px, 42vw, 160px);
          height: clamp(110px, 42vw, 160px);
          margin-top: 18px;
          margin-bottom: 28px;
        }

        .slideshow {
          right: 12px;
          bottom: 84px;
          width: clamp(120px, 42vw, 170px);
        }

        .play-button {
          right: 12px;
          bottom: 18px;
          transform: none;
        }

        .danmu-bar {
          left: 12px;
          right: 80px;
          bottom: 18px;
          padding: 8px 10px;
        }

        .danmu-item {
          font-size: 13px;
        }
      }
    </style>
  </head>
  <body>
    <div class="floating-layer" id="floating-layer"></div>
    <div class="stage">
      <h1>胡路路，我喜欢你</h1>
      <div class="lyrics" id="lyrics">点击播放，听见我们的心跳</div>
      <div class="heart">
        <div class="glow-ring"></div>
      </div>
      <p>愿你的笑容，点亮我的每一天。</p>
      <div class="signature">— 永远为你心动</div>
    </div>
    <figure class="slideshow" id="slideshow">
      <img id="photo-frame" src="" alt="甜蜜回放" />
      <figcaption>甜蜜回放</figcaption>
    </figure>
    <button
      class="play-button"
      id="photo-toggle"
      type="button"
      aria-label="暂停播放"
      aria-pressed="true"
    >
      <span id="toggle-icon">⏸</span>
    </button>
    <div class="danmu-layer" id="danmu-layer"></div>
    <div class="danmu-bar">
      <input
        id="danmu-input"
        type="text"
        placeholder="输入弹幕"
        maxlength="40"
        autocomplete="off"
      />
      <button type="button" id="danmu-send">发送</button>
    </div>
    <div class="note-backdrop" id="note-backdrop"></div>
    <div class="note-card" id="note-card" role="dialog" aria-hidden="true">
      <h2>想对你说</h2>
      <p>遇见你，是我这一生最温柔的幸运。</p>
      <button type="button" id="note-close">知道啦</button>
    </div>
    <audio id="bgm" preload="auto" loop></audio>
    <script>
      const layer = document.getElementById("floating-layer");
      const baseCount = 3;
      const bgm = document.getElementById("bgm");
      const audioSrc = "audio/建坤YOUNG,刘思鉴 - 声音.mp3";
      const lrcSrc = "audio/建坤YOUNG,刘思鉴 - 声音.lrc";
      const photoList = [];
      const photosEndpoint = "photos.json";
      const danmuEndpoint = (() => {
        try {
          const params = new URLSearchParams(window.location.search);
          const custom = params.get("danmu");
          if (custom && custom.trim()) {
            return custom.trim();
          }
        } catch (error) {}
        return "danmu";
      })();
      const slideshow = document.getElementById("slideshow");
      const photoFrame = document.getElementById("photo-frame");
      const toggleButton = document.getElementById("photo-toggle");
      const toggleIcon = document.getElementById("toggle-icon");
      const danmuLayer = document.getElementById("danmu-layer");
      const danmuInput = document.getElementById("danmu-input");
      const danmuSend = document.getElementById("danmu-send");
      const noteBackdrop = document.getElementById("note-backdrop");
      const noteCard = document.getElementById("note-card");
      const noteClose = document.getElementById("note-close");
      const lyricsEl = document.getElementById("lyrics");
      const intervalMs = 3000;
      const danmuStorageKey = "love_danmu_history";
      const maxDanmu = 50;
      let queue = [];
      let timer = null;
      let playing = false;
      let currentPhoto = "";
      let pressTimer = null;
      let pressOrigin = null;
      let ignoreNextClick = false;
      let lyricLines = [];
      let lyricIndex = -1;

      bgm.src = encodeURI(audioSrc);
      bgm.volume = 0.6;

      function parseLrc(text) {
        const lines = text.split(/\r?\n/);
        const result = [];
        for (const line of lines) {
          const match = line.match(/\[(\d{2}):(\d{2})(?:\.(\d{1,2}))?\](.*)/);
          if (!match) {
            continue;
          }
          const minutes = Number(match[1]);
          const seconds = Number(match[2]);
          const fraction = match[3] ? Number(match[3].padEnd(2, "0")) : 0;
          const time = minutes * 60 + seconds + fraction / 100;
          const content = match[4].trim();
          if (content) {
            result.push({ time, content });
          }
        }
        return result.sort((a, b) => a.time - b.time);
      }

      function syncLyrics(currentTime) {
        if (!lyricLines.length) {
          return;
        }
        let nextIndex = lyricIndex;
        for (let i = 0; i < lyricLines.length; i += 1) {
          if (currentTime >= lyricLines[i].time) {
            nextIndex = i;
          } else {
            break;
          }
        }
        if (nextIndex !== lyricIndex && lyricLines[nextIndex]) {
          lyricIndex = nextIndex;
          lyricsEl.textContent = lyricLines[nextIndex].content;
        }
      }

      function spawnHeart() {
        const heart = document.createElement("div");
        heart.className = "floating-heart";
        const size = 10 + Math.random() * 18;
        const duration = 4 + Math.random() * 4.5;
        const left = Math.random() * 100;
        heart.style.setProperty("--size", `${size}px`);
        heart.style.setProperty("--float-duration", `${duration}s`);
        heart.style.setProperty("--x", `${left}vw`);
        layer.appendChild(heart);
        window.setTimeout(() => {
          heart.remove();
        }, duration * 1000);
      }

      for (let i = 0; i < baseCount; i += 1) {
        spawnHeart();
      }

      window.setInterval(spawnHeart, 260);

      function shuffle(list) {
        const copy = [...list];
        for (let i = copy.length - 1; i > 0; i -= 1) {
          const j = Math.floor(Math.random() * (i + 1));
          [copy[i], copy[j]] = [copy[j], copy[i]];
        }
        return copy;
      }

      function nextPhoto() {
        if (!queue.length) {
          queue = shuffle(photoList);
        }
        let next = queue.shift();
        if (photoList.length > 1 && next === currentPhoto) {
          queue.push(next);
          next = queue.shift();
        }
        currentPhoto = next;
        return next;
      }

      function showPhoto(src) {
        if (!src) {
          return;
        }
        photoFrame.classList.add("is-fading");
        window.setTimeout(() => {
          photoFrame.src = src;
        }, 180);
      }

      function startLoop() {
        timer = window.setInterval(() => {
          showPhoto(nextPhoto());
        }, intervalMs);
      }

      function stopLoop() {
        if (timer) {
          window.clearInterval(timer);
          timer = null;
        }
      }

      function updateButton() {
        toggleIcon.textContent = playing ? "⏸" : "▶";
        toggleButton.setAttribute("aria-pressed", String(playing));
        toggleButton.setAttribute("aria-label", playing ? "暂停播放" : "播放照片");
        toggleButton.classList.toggle("is-playing", playing);
      }

      function showNote() {
        noteBackdrop.classList.add("is-visible");
        noteCard.classList.add("is-visible");
        noteCard.setAttribute("aria-hidden", "false");
      }

      function hideNote() {
        noteBackdrop.classList.remove("is-visible");
        noteCard.classList.remove("is-visible");
        noteCard.setAttribute("aria-hidden", "true");
      }

      function createBurst(x, y) {
        const count = 10;
        const maxDistance = 90;
        for (let i = 0; i < count; i += 1) {
          const heart = document.createElement("div");
          heart.className = "burst-heart";
          const angle = (Math.PI * 2 * i) / count;
          const distance = 30 + Math.random() * (maxDistance - 30);
          const dx = Math.cos(angle) * distance;
          const dy = Math.sin(angle) * distance * -1;
          heart.style.setProperty("--x", `${x}px`);
          heart.style.setProperty("--y", `${y}px`);
          heart.style.setProperty("--dx", `${dx}px`);
          heart.style.setProperty("--dy", `${dy}px`);
          document.body.appendChild(heart);
          window.setTimeout(() => {
            heart.remove();
          }, 1400);
        }
      }

      function loadDanmuHistory() {
        try {
          const raw = window.localStorage.getItem(danmuStorageKey);
          const list = raw ? JSON.parse(raw) : [];
          if (Array.isArray(list)) {
            return list.filter((item) => typeof item === "string" && item.trim());
          }
        } catch (error) {}
        return [];
      }

      function saveDanmuHistory(list) {
        try {
          window.localStorage.setItem(danmuStorageKey, JSON.stringify(list));
        } catch (error) {}
      }

      function pickDanmuTop() {
        const height = danmuLayer ? danmuLayer.clientHeight : window.innerHeight;
        const safeTop = 120;
        const safeBottom = 160;
        const maxTop = Math.max(safeTop, height - safeBottom);
        return safeTop + Math.random() * Math.max(0, maxTop - safeTop);
      }

      function spawnDanmu(text, delayMs = 0) {
        if (!danmuLayer) {
          return;
        }
        const content = text.trim();
        if (!content) {
          return;
        }
        const item = document.createElement("div");
        item.className = "danmu-item";
        item.textContent = content;
        item.style.top = `${pickDanmuTop()}px`;
        const duration =
          10 + Math.min(content.length, 20) * 0.2 + Math.random() * 2;
        item.style.setProperty("--duration", `${duration}s`);
        item.style.setProperty("--delay", `${delayMs / 1000}s`);
        danmuLayer.appendChild(item);
        item.addEventListener("animationend", () => {
          item.remove();
        });
      }

      function fetchDanmuFromServer() {
        if (!danmuEndpoint) {
          return Promise.resolve(null);
        }
        return fetch(encodeURI(danmuEndpoint), { cache: "no-store" })
          .then((response) => (response.ok ? response.json() : null))
          .then((list) => {
            if (!Array.isArray(list)) {
              return null;
            }
            return list
              .filter((item) => typeof item === "string" && item.trim())
              .slice(-maxDanmu);
          })
          .catch(() => null);
      }

      function postDanmuToServer(text) {
        if (!danmuEndpoint) {
          return Promise.resolve(false);
        }
        return fetch(encodeURI(danmuEndpoint), {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ text }),
        })
          .then((response) => response.ok)
          .catch(() => false);
      }

      function initDanmu() {
        if (!danmuLayer || !danmuInput || !danmuSend) {
          return;
        }
        const renderHistory = (list) => {
          list.forEach((text, index) => {
            spawnDanmu(text, index * 900);
          });
        };
        const localHistory = loadDanmuHistory();
        fetchDanmuFromServer().then((serverHistory) => {
          const history =
            serverHistory && serverHistory.length ? serverHistory : localHistory;
          if (serverHistory && serverHistory.length) {
            saveDanmuHistory(history);
          }
          renderHistory(history);
        });

        const send = () => {
          const raw = danmuInput.value.trim();
          if (!raw) {
            return;
          }
          const text = raw.slice(0, 40);
          danmuInput.value = "";
          const updated = loadDanmuHistory();
          updated.push(text);
          const trimmed = updated.slice(-maxDanmu);
          saveDanmuHistory(trimmed);
          spawnDanmu(text);
          postDanmuToServer(text);
        };

        danmuSend.addEventListener("click", send);
        danmuInput.addEventListener("keydown", (event) => {
          if (event.key === "Enter") {
            event.preventDefault();
            send();
          }
        });
      }

      function applyPhotoList(list) {
        photoList.splice(0, photoList.length, ...list);
      }

      function loadPhotos() {
        return fetch(encodeURI(photosEndpoint))
          .then((response) => (response.ok ? response.json() : []))
          .then((list) => {
            if (!Array.isArray(list)) {
              return;
            }
            const filtered = list.filter(
              (item) => typeof item === "string" && item.trim()
            );
            applyPhotoList(filtered);
          })
          .catch(() => {})
          .finally(() => {
            initSlideshow();
          });
      }

      function initSlideshow() {
      if (!photoList.length) {
        slideshow.style.display = "none";
        toggleButton.style.display = "none";
      } else {
        photoFrame.addEventListener("load", () => {
          photoFrame.classList.remove("is-fading");
        });
        showPhoto(nextPhoto());
        updateButton();
        fetch(encodeURI(lrcSrc))
          .then((response) => response.text())
          .then((text) => {
            lyricLines = parseLrc(text);
            if (!lyricLines.length) {
              lyricsEl.textContent = "想对你说的话，都藏在旋律里";
            }
          })
          .catch(() => {
            lyricsEl.textContent = "想对你说的话，都藏在旋律里";
          });
        bgm.addEventListener("timeupdate", () => {
          syncLyrics(bgm.currentTime);
        });
        bgm.addEventListener("seeked", () => {
          syncLyrics(bgm.currentTime);
        });
        bgm.addEventListener("play", () => {
          syncLyrics(bgm.currentTime);
        });
        toggleButton.addEventListener("click", () => {
          playing = !playing;
          updateButton();
          if (playing) {
            showPhoto(nextPhoto());
            startLoop();
            bgm
              .play()
              .then(() => {
                syncLyrics(bgm.currentTime);
              })
              .catch(() => {});
          } else {
            stopLoop();
            bgm.pause();
          }
        });
      }
      }

      loadPhotos();
      initDanmu();

      noteBackdrop.addEventListener("click", hideNote);
      noteClose.addEventListener("click", hideNote);

      document.addEventListener("pointerdown", (event) => {
        if (event.button !== 0) {
          return;
        }
        if (event.target.closest("button, .note-card, .note-backdrop")) {
          return;
        }
        pressOrigin = { x: event.clientX, y: event.clientY };
        pressTimer = window.setTimeout(() => {
          showNote();
          ignoreNextClick = true;
          pressTimer = null;
        }, 620);
      });

      document.addEventListener("pointermove", (event) => {
        if (!pressTimer || !pressOrigin) {
          return;
        }
        const dx = event.clientX - pressOrigin.x;
        const dy = event.clientY - pressOrigin.y;
        if (Math.hypot(dx, dy) > 12) {
          window.clearTimeout(pressTimer);
          pressTimer = null;
        }
      });

      document.addEventListener("pointerup", () => {
        if (pressTimer) {
          window.clearTimeout(pressTimer);
          pressTimer = null;
        }
        pressOrigin = null;
      });

      document.addEventListener("pointercancel", () => {
        if (pressTimer) {
          window.clearTimeout(pressTimer);
          pressTimer = null;
        }
        pressOrigin = null;
      });

      document.addEventListener("click", (event) => {
        if (ignoreNextClick) {
          ignoreNextClick = false;
          return;
        }
        if (event.target.closest("button, .note-card, .note-backdrop")) {
          return;
        }
        createBurst(event.clientX, event.clientY);
      });
    </script>
  </body>
</html>
